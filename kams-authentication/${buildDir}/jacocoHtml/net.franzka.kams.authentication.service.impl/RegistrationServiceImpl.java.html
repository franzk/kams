<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegistrationServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kams-authentication</a> &gt; <a href="index.source.html" class="el_package">net.franzka.kams.authentication.service.impl</a> &gt; <span class="el_source">RegistrationServiceImpl.java</span></div><h1>RegistrationServiceImpl.java</h1><pre class="source lang-java linenums">package net.franzka.kams.authentication.service.impl;

import jakarta.transaction.Transactional;
import net.franzka.kams.authentication.dto.UserDto;
import net.franzka.kams.authentication.exception.ActivationTokenExpiredException;
import net.franzka.kams.authentication.exception.UserAlreadyActivatedException;
import net.franzka.kams.authentication.exception.UserAlreadyExistsException;
import net.franzka.kams.authentication.exception.WrongActivationTokenException;
import net.franzka.kams.authentication.model.UnverifiedUser;
import net.franzka.kams.authentication.model.User;
import net.franzka.kams.authentication.repository.UnverifiedUserRepository;
import net.franzka.kams.authentication.repository.UserRepository;
import net.franzka.kams.authentication.service.RandomString;
import net.franzka.kams.authentication.service.RegistrationService;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.Optional;

/**
 * Handle new user registration
 */
@Service
public class RegistrationServiceImpl implements RegistrationService {
    private final UnverifiedUserRepository unverifiedUserRepository;
    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

<span class="fc" id="L32">    public RegistrationServiceImpl(UnverifiedUserRepository unverifiedUserRepository, UserRepository userRepository, PasswordEncoder passwordEncoder) {</span>
<span class="fc" id="L33">        this.unverifiedUserRepository = unverifiedUserRepository;</span>
<span class="fc" id="L34">        this.userRepository = userRepository;</span>
<span class="fc" id="L35">        this.passwordEncoder = passwordEncoder;</span>
<span class="fc" id="L36">    }</span>

    /**
     * New user registration
     * @param userDto : {@link UserDto} that contains the data of the new user
     * @return {@link UserDto} that contains the data of the unverified user created
     * @throws {@link UserAlreadyExistsException}
     */
    @Transactional
    public UserDto register(UserDto userDto) throws UserAlreadyExistsException {

        // if an active user with this email exists in User table, throw an exception
<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (userRepository.findByEmail(userDto.getEmail()).isPresent()) throw new UserAlreadyExistsException();</span>

        // delete the previous inactive registrations with this email in UnverifiedUser table
<span class="fc" id="L51">        unverifiedUserRepository.deleteByEmail(userDto.getEmail());</span>

        // save the new unverified user
<span class="fc" id="L54">        UnverifiedUser unverifiedUser = unverifiedUserRepository.save(makeNewUnverifiedUser(userDto));</span>

        // return a DTO with the new unverified user infos
<span class="fc" id="L57">        UserDto result = new UserDto();</span>
<span class="fc" id="L58">        result.setEmail(unverifiedUser.getEmail());</span>
<span class="fc" id="L59">        result.setRole(unverifiedUser.getRole());</span>
<span class="fc" id="L60">        return result;</span>

    }

    /**
     * Map {@link UserDto} to {@link UnverifiedUser} and encode password
     * @param userDto
     * @return
     */
    protected UnverifiedUser makeNewUnverifiedUser(UserDto userDto) {

<span class="fc" id="L71">        UnverifiedUser newUnverifiedUser = new UnverifiedUser();</span>
<span class="fc" id="L72">        newUnverifiedUser.setEmail(userDto.getEmail());</span>
<span class="fc" id="L73">        newUnverifiedUser.setPassword(passwordEncoder.encode(userDto.getPassword()));</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (userDto.getRole() != null) {</span>
<span class="fc" id="L75">            newUnverifiedUser.setRole(userDto.getRole());</span>
        }
<span class="fc" id="L77">        newUnverifiedUser.setActivationToken(RandomString.generateRandomString(64));</span>
<span class="fc" id="L78">        newUnverifiedUser.setCreationTime(LocalDateTime.now());</span>
<span class="fc" id="L79">        return newUnverifiedUser;</span>
    }

    @Value(&quot;${net.franzka.kams.authentication.activationtoken-expiration-in-minutes}&quot;)
    private int validationTokenDuration;

    /**
     * Activate new User : &lt;br&gt;
     * Copy the {@link UnverifiedUser} found with the activationToken into a new {@link User} and save it. &lt;br&gt;
     * And then delete this {@link UnverifiedUser}
     * @param activationToken : The activation token of the unverified user to activate
     * @return the created {@link User}
     * @throws WrongActivationTokenException
     * @throws UserAlreadyActivatedException
     * @throws ActivationTokenExpiredException
     */
    @Transactional
    public User activate(String activationToken) throws WrongActivationTokenException, UserAlreadyActivatedException, ActivationTokenExpiredException {

<span class="fc" id="L98">        Optional&lt;UnverifiedUser&gt; optionalUnverifiedUser = unverifiedUserRepository.findByActivationToken(activationToken);</span>

        // Wrong Token
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (optionalUnverifiedUser.isEmpty()) {</span>
<span class="fc" id="L102">            throw new WrongActivationTokenException();</span>
        }

<span class="fc" id="L105">        UnverifiedUser unverifiedUser = optionalUnverifiedUser.get();</span>

        // User already activated
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (userRepository.findByEmail(unverifiedUser.getEmail()).isPresent()) {</span>
<span class="fc" id="L109">            throw new UserAlreadyActivatedException();</span>
        }

        // Token expired
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (Duration.between(unverifiedUser.getCreationTime(), LocalDateTime.now()).toMinutes() &gt; validationTokenDuration) {</span>
<span class="fc" id="L114">            throw new ActivationTokenExpiredException();</span>
        }

        // Creation of the new user and deletion of then unverifiedUser
<span class="fc" id="L118">        User newUser = new User();</span>
<span class="fc" id="L119">        newUser.setEmail(unverifiedUser.getEmail());</span>
<span class="fc" id="L120">        newUser.setPassword(unverifiedUser.getPassword());</span>
<span class="fc" id="L121">        newUser.setRole(unverifiedUser.getRole());</span>

<span class="fc" id="L123">        userRepository.save(newUser);</span>

<span class="fc" id="L125">        unverifiedUserRepository.delete(unverifiedUser);</span>

<span class="fc" id="L127">        return newUser;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>